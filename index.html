<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>o r a c L e</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>
    <!-- Uncomment for local p5.js -->
    <!-- <script src="p5.min.js"></script> -->
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #000 !important;
            font-family: 'monospace', monospace;
               font-size: 10px;
            color: #7bd3f7 !important;
            user-select: none;
        }
        #fractal-container {
            position: absolute;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 0;
        }
        a:link {
  color: green;
  background-color: transparent;
  text-decoration: none;
}
        
        #fractal-canvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 0;
        }
        #audio-mandala {
            position: relative;
            width: 90vmin !important;
            height: 90vmin !important;
            z-index: 1;
        }
        .parameter-node {
            position: absolute;
            width: 40px !important;
            height: 40px !important;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 10px;
            z-index: 10;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.3) !important;
        
        }
        .parameter-node:hover {
            transform: translate(-50%, -50%) scale(1.5);
        }
        .parameter-node.active {
            box-shadow: 0 0 15px currentColor !important;
        }
        .node-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: #7bd3f7;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 10px;
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 101;
            border: 1px solid #7bd3f7;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
        }
        .parameter-node:hover:not([data-clicked]) .node-tooltip {
            opacity: 1;
        }
        .node-process {
            width: 65px !important;
            height: 65px !important;
            font-size: 12px;
            box-shadow: 0 0 15px currentColor !important;
        }
        
           .node-file-inputs {
            width: 55px !important;
            height: 55px !important;
            font-size: 12px;
            box-shadow: 0 0 15px currentColor !important;
        }
        
        
        .node-player, .node-help, .node-waveform {
            width: 35px !important;
            height: 35px !important;
            font-size: 11px;
            box-shadow: 0 0 12px currentColor !important;
        }
        
         .node-stop {
            width: 50px !important;
            height: 50px !important;
            font-size: 11px;
            box-shadow: 0 0 12px currentColor !important;
        }
        
        .node-waveform {
            animation: slow-glow 4s ease-in-out infinite;
        }
        @keyframes slow-glow {
            0% { box-shadow: 0 0 12px rgba(211, 123, 247, 0.3); }
            50% { box-shadow: 0 0 20px rgba(211, 123, 247, 0.8); }
            100% { box-shadow: 0 0 12px rgba(211, 123, 247, 0.3); }
        }
        .node-connection {
            position: absolute;
            height: 1px;
            background: linear-gradient(90deg, rgba(123, 211, 247, 0), #7bd3f7, rgba(123, 211, 247, 0));
            transform-origin: 0 0;
            z-index: 1;
            opacity: 0.3;
        }
#control-panel {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.9) !important;
    padding: 15px;
    border-radius: 10px;
    border: 1px solid #7bd3f7;
    z-index: 100;
    min-width: 150px;
    max-width: 90vw; /* Changed from fixed width to viewport width */
    box-shadow: 0 0 20px rgba(123, 211, 247, 0.5);
    display: none;
    transition: opacity 0.3s ease, transform 0.3s ease;
}
        
        #control-panel[style*="display: none"] {
    opacity: 0;
    transform: scale(0.9);
}
        
        .control-group {
            margin-bottom: 10px;
            position: relative;
        }
        .control-group label {
            color: #7bd3f7;
            font-size: 10px;
            margin-bottom: 5px;
            display: block;
        }
        .control-group input, .control-group select {
            background: rgba(123, 211, 247, 0.1);
            color: #7bd3f7;
            border: 1px solid #7bd3f7;
            border-radius: 3px;
            padding: 5px;
            width: 100%;
            font-size: 12px;
        }
        .control-group input[type="range"]::-webkit-slider-thumb {
            background: #7bd3f7;
            border-radius: 50%;
            width: 15px;
            height: 15px;
            cursor: pointer;
        }
        .tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: #7bd3f7;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 101;
            border: 1px solid #7bd3f7;
        }
        .control-group:hover .tooltip {
            opacity: 1;
        }
#status-display {
    position: fixed; /* Changed from absolute to fixed */
    top: 50%; /* Changed from bottom to top */
    left: 50%;
    transform: translate(-50%, -50%); /* Added Y-axis translation */
    background: rgba(0, 0, 0, 0.9) !important;
    padding: 15px; /* Slightly more padding like control-panel */
    border-radius: 10px; /* Larger radius like control-panel */
    border: 1px solid #7bd3f7;
    max-width: 200px; /* Similar to control-panel */
    text-align: center;
    z-index: 100;
    pointer-events: none;
    font-size: 12px; /* Slightly smaller text */
    display: none;
    opacity: 0;
    transition: opacity 0.3s ease, transform 0.3s ease; /* Added transform transition */
    box-shadow: 0 0 20px rgba(123, 211, 247, 0.5); /* Added glow like control-panel */
}

#status-display[style*="display: block"] {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1); /* Added scale animation */
}
        #file-inputs {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9) !important;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #7bd3f7;
            z-index: 100;
            width: 300px;
            max-width: 90%;
            box-shadow: 0 0 30px rgba(123, 211, 247, 0.5);
            display: none;
            max-height: 70vh;
            overflow-y: auto;
        }
        .upload-area {
            border: 2px dashed #7bd3f7;
            border-radius: 5px;
            padding: 20px;
            text-align: center;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
            color: #7bd3f7;
            font-size: 14px;
        }
        .upload-area:hover {
            background: rgba(123, 211, 247, 0.1);
        }
        .file-upload-input {
            margin-bottom: 10px;
            font-size: 12px;
        }
        .file-upload-input label {
            color: #7bd3f7;
            margin-right: 10px;
        }
        .file-upload-input input[type="file"] {
            color: #7bd3f7;
        }
        .file-name, .file-error, .file-bpm {
            color: #7bd3f7;
            font-size: 10px;
            display: block;
        }
        .file-waveform {
            width: 100%;
            height: 40px;
            margin-top: 5px;
        }
        button {
            background: rgba(123, 211, 247, 0.3);
            color: #7bd3f7;
            border: 1px solid #7bd3f7;
            border-radius: 3px;
            padding: 8px 15px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
                align-items: center;
        }
        button:hover:not(:disabled) {
            background: rgba(123, 211, 247, 0.6);
            box-shadow: 0 0 10px rgba(123, 211, 247, 0.7);
                align-items: center;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
                align-items: center;
        }
        
.button-group button:hover:not(:disabled) {
    background: rgba(123, 211, 247, 0.6);
    box-shadow: 0 0 10px rgba(123, 211, 247, 0.7);
}

.button-group button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}
/* For side-by-side buttons */
.button-group {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
}
.button-group button {
    width: 150px;
    padding: 8px 15px;
    background: rgba(123, 211, 247, 0.3);
    color: #7bd3f7;
    border: 1px solid #7bd3f7;
    border-radius: 3px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.3s;
}
        #audio-player-container {
            position: fixed;
            top: 60%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 150px !important;
            z-index: 50;
            opacity: 0.8;
            transition: opacity 0.3s;
            background: rgba(0, 0, 0, 0.7) !important;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #7bd3f7;
            box-shadow: 0 0 20px rgba(123, 211, 247, 0.5);
            display: none;
        }
        #audio-player-container:hover {
            opacity: 1;
        }
        #mixed-audio {
            width: 100%;
            margin-top: 5px;
        }
        #close-player {
            position: absolute;
            top: -15px;
            right: -15px;
            width: 30px;
            height: 30px;
            background: rgba(247, 123, 211, 0.3);
            border: 1px solid #f77bd3;
            border-radius: 50%;
            color: #f77bd3;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        #close-player:hover {
            background: rgba(247, 123, 211, 0.6);
            transform: scale(1.2);
        }
        #stop-audio-btn {
            position: absolute;
            top: -15px;
            left: -15px;
            width: 30px;
            height: 30px;
            background: rgba(123, 211, 247, 0.3);
            border: 1px solid #7bd3f7;
            border-radius: 50%;
            color: #7bd3f7;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        #stop-audio-btn:hover {
            background: rgba(123, 211, 247, 0.6);
            transform: scale(1.2);
        }
        #waveform-container {
            position: fixed;
            top: calc(50% - 1px);
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            opacity: 0.8;
            transition: opacity 0.3s;
            background: rgba(0, 0, 0, 0.7) !important;
               width: 150px !important;  /* Adjust size as needed */
    height: 150px !important;
    border-radius: 50%;
    overflow: hidden;
    box-shadow: 0 0 20px rgba(123, 211, 247, 0.7);
            display: none;
        }
        #waveform-container:hover {
            opacity: 1;
        }
      #waveform-canvas {
  position: absolute; /* ✅ Stay inside parent */
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
}
        #logo {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            font-size: 14px !important;
            color: #7bd3f7 !important;
            opacity: 0.7;
            z-index: 20;
            text-align: center;
            font-family: 'monospace', monospace;
            pointer-events: none;
            animation: glow 2s ease-in-out infinite;
        }
        #help-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9) !important;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #7bd3f7;
            z-index: 100;
            width: 500px;
            max-width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 0 30px rgba(123, 211, 247, 0.5);
            display: none;
            color: #7bd3f7;
            font-family: 'Arial', sans-serif;
        }
        #help-panel h1, #help-panel h2, #help-panel h3 {
            color: #7bd3f7;
            text-shadow: 0 0 5px rgba(123, 211, 247, 0.5);
        }
        #help-panel p, #help-panel ul, #help-panel li {
            font-size: 14px;
            line-height: 1.5;
        }
        #help-panel ul {
            padding-left: 20px;
        }
        #close-help {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 30px;
            height: 30px;
            background: rgba(247, 123, 211, 0.3);
            border: 1px solid #f77bd3;
            border-radius: 50%;
            color: #f77bd3;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        #close-help:hover {
            background: rgba(247, 123, 211, 0.6);
            transform: scale(1.2);
        }
        @keyframes glow {
            0% { text-shadow: 0 0 5px rgba(123, 211, 247, 0.5); }
            50% { text-shadow: 0 0 10px rgba(123, 211, 247, 0.8); }
            100% { text-shadow: 0 0 5px rgba(123, 211, 247, 0.5); }
        }
        @keyframes pulse {
            0% { opacity: 0.3; }
            50% { opacity: 1; }
            100% { opacity: 0.3; }
        }
        .pulse {
            animation: pulse 3s infinite;
        }
        @keyframes ripple {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(3); opacity: 0; }
        }
        .ripple-effect {
            position: absolute;
            border-radius: 50%;
            background: rgba(123, 211, 247, 0.6);
            transform: translate(-50%, -50%);
            pointer-events: none;
            animation: ripple 1s linear;
            z-index: 5;
        }
.parameter-node.blinking {
    animation: random-blink var(--blink-duration) infinite alternate;
}

@keyframes random-blink {
    0% { opacity: 0.3; }
    100% { opacity: 1; }
}
    </style>
</head>
<body>
    <div id="fractal-container">
        <canvas id="fractal-canvas"></canvas>
        <div id="audio-mandala">
            <div class="parameter-node" id="node-track-count" style="background: rgba(123, 211, 247, 0.3); border-color: #7bd3f7; color: #7bd3f7;" data-tooltip="Number of Tracks"><span class="node-tooltip"></span></div>
            <div class="parameter-node" id="node-project-bpm" style="background: rgba(247, 123, 211, 0.3); border-color: #f77bd3; color: #f77bd3;" data-tooltip="Project BPM"><span class="node-tooltip"></span></div>
            <div class="parameter-node" id="node-max-blend" style="background: rgba(176, 123, 247, 0.3); border-color: #b07bf7; color: #b07bf7;" data-tooltip="Max Blend"><span class="node-tooltip"></span></div>
            <div class="parameter-node" id="node-wet-dry" style="background: rgba(123, 247, 163, 0.3); border-color: #7bf7a3; color: #7bf7a3;" data-tooltip="Wet/Dry Mix"><span class="node-tooltip"></span></div>
            <div class="parameter-node" id="node-reverb-time" style="background: rgba(247, 211, 123, 0.3); border-color: #f7d37b; color: #f7d37b;" data-tooltip="Reverb Time"><span class="node-tooltip"></span></div>
            <div class="parameter-node" id="node-loop-duration" style="background: rgba(123, 163, 247, 0.3); border-color: #7ba3f7; color: #7ba3f7;" data-tooltip="Loop Duration"><span class="node-tooltip"></span></div>
            <div class="parameter-node" id="node-algorithm" style="background: rgba(211, 123, 247, 0.3); border-color: #d37bf7; color: #d37bf7;" data-tooltip="Algorithm"><span class="node-tooltip"></span></div>
            <div class="parameter-node" id="node-musical-scale" style="background: rgba(247, 123, 123, 0.3); border-color: #f77b7b; color: #f77b7b;" data-tooltip="Musical Scale"><span class="node-tooltip"></span></div>
            <div class="parameter-node" id="node-scale-behavior" style="background: rgba(123, 247, 211, 0.3); border-color: #7bf7d3; color: #7bf7d3;" data-tooltip="Scale Behavior"><span class="node-tooltip"></span></div>
            <div class="parameter-node" id="node-playback-rate" style="background: rgba(163, 123, 247, 0.3); border-color: #a37bf7; color: #a37bf7;" data-tooltip="Playback Rate"><span class="node-tooltip"></span></div>
            <div class="parameter-node" id="node-preserve-pitch" style="background: rgba(247, 163, 123, 0.3); border-color: #f7a37b; color: #f7a37b;" data-tooltip="Preserve Pitch"><span class="node-tooltip"></span></div>
            <div class="parameter-node" id="node-silence" style="background: rgba(123, 211, 163, 0.3); border-color: #7bd3a3; color: #7bd3a3;" data-tooltip="Silence Percentage"><span class="node-tooltip"></span></div>
            <div class="parameter-node node-file-inputs" id="node-file-inputs" style="background: rgba(211, 247, 123, 0.3); border-color: #d3f77b; color: #d3f77b;" data-tooltip="Upload Files"><span class="node-tooltip"></span></div>
            <div class="parameter-node node-process" id="node-process" style="background: rgba(247, 123, 163, 0.3); border-color: #f77ba3; color: #f77ba3;" data-tooltip="Process Audio"><span class="node-tooltip"></span></div>
            <div class="parameter-node node-player" id="node-player" style="background: rgba(123, 247, 247, 0.3); border-color: #7bf7f7; color: #7bf7f7;" data-tooltip="Show/Hide Player"><span class="node-tooltip"></span></div>
            <div class="parameter-node node-stop" id="node-stop-audio" style="background: rgba(247, 123, 247, 0.3); border-color: #f77bf7; color: #f77bf7;" data-tooltip="Stop Audio"><span class="node-tooltip"></span></div>
            <div class="parameter-node node-help" id="node-help" style="background: rgba(123, 247, 211, 0.3); border-color: #7bf7d3; color: #7bf7d3;" data-tooltip="Help"><span class="node-tooltip"></span></div>
            <div class="parameter-node node-waveform" id="node-waveform" style="background: rgba(211, 123, 247, 0.3); border-color: #d37bf7; color: #d37bf7;" data-tooltip="Show/Hide Waveform"><span class="node-tooltip"></span></div>
            <div class="node-connection" id="conn-1"></div>
            <div class="node-connection" id="conn-2"></div>
            <div class="node-connection" id="conn-3"></div>
            <div class="node-connection" id="conn-4"></div>
            <div class="node-connection" id="conn-5"></div>
            <div class="node-connection" id="conn-6"></div>
            <div class="node-connection" id="conn-7"></div>
            <div class="node-connection" id="conn-8"></div>
            <div class="node-connection" id="conn-9"></div>
            <div id="logo">o r a c L e</div>
        </div>
        <div id="control-panel">
            <h2>Parameter Control</h2>
            <div class="control-group" id="control-track-count" style="display: none;">
                <label for="track-count">Number of Tracks:</label>
                <select id="track-count" name="track-count">
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5" selected>5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                </select>
                <span class="tooltip">Adjust number of audio tracks (2-10)</span>
            </div>
       <div class="control-group" id="control-project-bpm" style="display: none;">
    <label for="project-bpm-slider">Project BPM: <span id="bpm-value">120</span></label>
    <input type="range" 
           id="project-bpm-slider" 
           min="40" 
           max="240" 
           value="120"
           step="1"
           oninput="document.getElementById('bpm-value').textContent = this.value + ' BPM'; window.projectBPM = parseInt(this.value);">
    <span class="tooltip">Adjust tempo (40-240 BPM)</span>
</div>
            <div class="control-group" id="control-max-blend" style="display: none;">
                <label for="max-blend">Max Blend (%):</label>
                <input type="range" id="max-blend" min="0" max="100" value="50">
                <span id="blend-value">50%</span>
                <span class="tooltip">Control maximum blend between tracks</span>
            </div>
            <div class="control-group" id="control-wet-dry" style="display: none;">
                <label for="wet-dry">Wet/Dry Mix:</label>
                <input type="range" id="wet-dry" min="0" max="1" step="0.01" value="0.5">
                <span id="wet-dry-value">50%</span>
                <span class="tooltip">Balance between reverb and dry signal</span>
            </div>
            <div class="control-group" id="control-reverb-time" style="display: none;">
                <label for="reverb-time">Reverb Time (s):</label>
                <input type="range" id="reverb-time" min="0.1" max="5" step="0.1" value="2.0">
                <span id="reverb-time-value">2.0s</span>
                <span class="tooltip">Set reverb decay time</span>
            </div>
            <div class="control-group" id="control-loop-duration" style="display: none;">
                <label for="loop-duration">Loop Duration (min):</label>
                <input type="range" id="loop-duration" min="0.1" max="10" step="0.1" value="5">
                <span id="loop-duration-value">1.0</span>
                <span class="tooltip">Set duration for looping mix</span>
            </div>
            <div class="control-group" id="control-algorithm" style="display: none;">
                <label for="algorithm-select">Algorithm:</label>
                <select id="algorithm-select">
                    <option value="sequential">Sequential</option>
                    <option value="random">Random</option>
                    <option value="markov">Markov Chain</option>
                    <option value="scale-order-asc">Scale Ascending</option>
                    <option value="scale-order-desc">Scale Descending</option>
                    <option value="freq-asc">Center Freq Ascending</option>
                    <option value="freq-desc">Center Freq Descending</option>
                    <option value="tempo-asc">Tempo Ascending</option>
                    <option value="tempo-desc">Tempo Descending</option>
                </select>
                <span class="tooltip">Choose track ordering algorithm</span>
            </div>
            <div class="control-group" id="control-musical-scale" style="display: none;">
                <label for="musical-scale">Musical Scale:</label>
                <select id="musical-scale">
                    <option value="none">None</option>
                    <option value="major">Major</option>
                    <option value="minor">Minor</option>
                    <option value="harmonicMinor">Harmonic Minor</option>
                    <option value="melodicMinor">Melodic Minor</option>
                    <option value="pentatonic">Pentatonic</option>
                    <option value="blues">Blues</option>
                    <option value="chromatic">Chromatic</option>
                      <label for="musical-scale">Exerimental:</label>
                          <option value="twelveToneRow">twelveToneRow</option>
                    <option value="ligeti">Ligeti</option>
                       <option value="bartok">Bartok</option>
                    <option value="messiaen3">Messiaen3</option>
                    <option value="pelog">Pelog</option>
                    <option value="slendro">Slendro</option>
                    <option value="partch43">Harry Partch</option>
                    <option value="hexany">Hexany</option>
                    <option value="slendro">Slendro</option>
                    <option value="alpha">Alpha</option>
                       <option value="enigmatic">Enigmatic</option>
                    <option value="prometheus">Prometheus</option>
                             <option value="wholeTone">WholeTone</option>
                    <option value="octatonic">Octatonic</option>
                 
                </select>
                <span class="tooltip">Select musical scale for filtering</span>
            </div>
            <div class="control-group" id="control-scale-behavior" style="display: none;">
                <label for="scale-behavior">Scale Behavior:</label>
                <select id="scale-behavior">
                    <option value="filter">Filter</option>
                    <option value="transpose">Transpose</option>
                    <option value="reorder">Reorder</option>
                </select>
                <span class="tooltip">Define scale adjustment behavior</span>
            </div>
      <div class="control-group" id="control-playback-rate" style="display: none;">
    <label for="playback-rate">Playback Rate:</label>
   <input type="range" id="playback-rate" min="0.1" max="2" step="0.01" value="1.0">
<span id="playback-rate-value">1.00x</span>
 <span class="tooltip">Adjust playback speed (10%–200%)</span>
</div>
            <div class="control-group" id="control-preserve-pitch" style="display: none;">
                <label for="preserve-pitch">Preserve Pitch:</label>
                <input type="checkbox" id="preserve-pitch" checked>
                <span class="tooltip">Maintain pitch when changing rate</span>
            </div>
            <div class="control-group" id="control-silence" style="display: none;">
                <label for="silence-percentage">Silence (%):</label>
                <input type="range" id="silence-percentage" min="0" max="100" value="10">
                <span id="silence-value">10%</span>
                <span class="tooltip">Add silence between tracks</span>
            </div>
      <div class="control-group" id="control-process" style="display: none;">
    <div class="button-group">
        <button id="process-btn">PROCESS AUDIO</button>
        <button id="download-btn" disabled>MIX DOWNLOAD</button>
    </div>
    <span class="tooltip">Audio processing controls</span>
</div>
        </div>
        <div id="file-inputs">
            <div class="upload-area">Drag and drop audio files or click to select</div>
       <div style="margin: 10px 0; text-align: center;">
        <input type="checkbox" id="loop-all-checkbox" style="margin-right: 5px;">
        <label for="loop-all-checkbox" style="color: #7bd3f7; font-size: 12px;">Loop All Files</label>
    </div>
        </div>
        <div id="status-display"></div>
        <div id="audio-player-container">
            <button id="close-player">×</button>
            <button id="stop-audio-btn">■</button>
            <audio id="mixed-audio" controls></audio>
        </div>
        <div id="waveform-container">
            <canvas id="waveform-canvas"></canvas>
        </div>
        <div id="help-panel">
            <button id="close-help">×</button>
            <div id="help-content"></div>
        </div>
        <canvas id="waveform" style="display: none;"></canvas>
        <div id="loop-status" style="display: none;"></div>
    </div>
    <script src="app.js"></script>
    <script>
        const helpContent = document.getElementById('help-content');
        const helpPanel = document.getElementById('help-panel');
        const closeHelp = document.getElementById('close-help');
        const manualContent = `
<h1>[ o r a c L e ]</h1>

<h2>Overview</h2>
<p>The <strong>o r a c L e</strong> is an audio processing tool that blends multiple audio tracks into a cohesive mix.</p>
<h2>Interface Elements</h2>
<p>The app is centered around a mandala with interactive nodes, each controlling a specific function. Based on frequency  (FFT) and tempo analysis, in combination with user's adjustments of specific algorithmic functions, new soundscapes emerge. <BR> <BR> The functions of <strong> silences and mix blending, </strong> together with  <strong>Scale Selection, Scale Behavior and Playback Order, </strong> helps the [ o r a c L e ] to predict new soundscapes. </p>
<p>For sound artists, [ o r a c L e ] becomes a dynamic playground for sonic experimentation. By blending algorithmic processing with intuitive controls, it transforms raw audio into evolving soundscapes. Real-time processing and generative algorithms act as a creative collaborator, revealing hidden musical structures in uploaded samples. Whether crafting minimalistic sonic textures, ambient beds, rhythmic glitches or microtonal collages, the app rewards curiosity with unexpected results, making it a tool for both intentional composition and happy accidents. </p>
<h3>Key Components</h3>
<ul>
    <li><strong>Mandala Nodes</strong>: Circular controls around the central mandala, each tied to a parameter or action (e.g., track count, BPM, file uploads). Hover over a node to see its tooltip explanation (shown only until the node is first clicked).</li>
    <li><strong>Control Panel</strong>: A sidebar for fine-tuning parameters, appearing when a node is clicked.</li>
    <li><strong>File Upload Panel</strong>: A central popup for uploading audio files.</li>
    <li><strong>Audio Player</strong>: A compact player for previewing and controlling the mixed audio.</li>
    <li><strong>Waveform Display</strong>: Visualizes the mixed audio's waveform in real-time, hidden after one audio loop.</li>
    <li><strong>Status Display</strong>: Shows temporary messages (e.g., "Track loaded") at the bottom-right.</li>
    <li><strong>Help Node</strong>: A glowing node in the mandala to open this manual.</li>
    <li><strong>Waveform Node</strong>: A slowly pulsing node to toggle the waveform display.</li>
    <li><strong>o r a c L e Logo</strong>: A pulsating centerpiece tying the interface together.</li>
</ul>
<h2>How to Use</h2>
    <li><strong>BEST METHOD:</strong> Start from the <strong>Number of Tracks Node</strong> (first Node on your right - see Tooltip) and follow the Nodes of the mandala down in series until you reach the <strong>Process Audio</strong> Node. Adjust settings as you go. </li>

<li><strong>IMPORTANT:</strong> While learning the app, import sounds with a <strong>clear pitch and small in size</strong> (less than 10Mb). Some piano sounds samples are linked at the end of this Help to try. After you get familiarized with the app's logic, try more complex sounds. </li>

<li>Set <strong>MAX BLEND</strong> around 80%. A basic feature of the app.</li>


<li>Set <strong>Loop Time around ONE minute</strong> to render quicker (Default 5 minutes). <strong></li>

<li>Check Loop</strong> on each track before Process Audio.</li>

<li>Press <strong>Process Audio</strong> and wait to hear a new soundscape to emerge (Depending of the Loop Length Node and the size of the tracks, rendering times can vary.  </li>

<li>Wait until 'Process Audio...Please Wait' message clears. Then sound starts automatically.</li>


<li><strong>Experiment:</strong> Try different settings with the same imported sounds and observe sound differencies. </li>

<li><strong>REALTIME:</strong> The [ o r a c L e ] predicts sounds in REALTIME. After rendering, play with available parameters and notice changes in the soundscape. </li>

<li><strong>Alternative:</strong> Just set the number of tracks, import accordingly, check Loops on each one and hit Process Audio... Then just <strong>Play</strong> </li>

<h2>Features</h2>

<h3>1. Uploading Audio Files</h3>
<ul>
    <li><strong>Access</strong>: Click the <strong>Upload Files</strong> node (yellow-green, labeled "Upload Files"). Hover to see its tooltip before clicking.</li>
    <li><strong>Action</strong>: The file upload panel appears in the center. Drag and drop audio files (e.g., MP3, WAV) into the upload area or click to select files manually.</li>
    <li><strong>Details</strong>: The number of file slots depends on the <strong>Number of Tracks</strong> setting (2–10). Each slot shows the file name and a waveform preview after upload.</li>
    <li><strong>Status</strong>: The status display confirms each file loaded (e.g., "Track 1 loaded: song.mp3"). When all tracks are loaded, the panel closes automatically, and the status shows "All tracks loaded. Ready to process."</li>
</ul>
<h3>2. Setting Parameters</h3>
<p>Click a parameter node to open the control panel on the right. Adjust settings and see real-time feedback in the status display. Hover over a node to see its tooltip (until clicked). Available parameters:</p>
<ul>
    <li><strong>Number of Tracks (2–10)</strong>: Sets how many audio files to upload. Default: 5.</li>
    <li><strong>Project BPM (60–240)</strong>: Sets the project tempo for alignment (affects visualization, not playback).</li>
    <li><strong>Max Blend (0–100%)</strong>: Controls track overlap intensity.</li>
    <li><strong>Wet/Dry Mix (0–100%)</strong>: Balances reverb and original audio.</li>
    <li><strong>Reverb Time (0.1–5s)</strong>: Sets reverb decay length.</li>
    <li><strong>Loop Duration (0.1–10 min)</strong>: Defines the output mix duration.</li>
    <li><strong>Algorithm</strong>: Chooses track ordering (e.g., Sequential, Random, Markov Chain, Scale-based, Frequency-based, Tempo-based).</li>
    <li><strong>Musical Scale</strong>: Filters tracks by scale (e.g., Major, Minor, Pentatonic and mnay more exotic scales).</li>
    <li><strong>Scale Behavior</strong>: Defines scale application (Filter, Transpose, Reorder).</li>
    <li><strong>Playback Rate (0.5–2x)</strong>: Adjusts playback speed.</li>
    <li><strong>Preserve Pitch</strong>: Maintains pitch when changing playback rate (checked by default).</li>
    <li><strong>Silence Percentage (0–100%)</strong>: Adds silence between tracks.</li>
</ul>
<p><strong>Usage</strong>: Click a node (e.g., "Project BPM"), adjust the slider/input in the control panel, and see the status update (e.g., "Project BPM updated to 140"). The mandala pulses with each interaction. Tooltips disappear after clicking a node.</p>
<h3>3. Processing Audio</h3>
<ul>
    <li><strong>Access</strong>: Click the <strong>Process Audio</strong> node (pink, labeled "Process Audio").</li>
    <li><strong>Action</strong>: Combines uploaded tracks based on parameters (e.g., reverb, playback rate, algorithm). The process uses the Web Audio API to mix tracks offline.</li>
    <li><strong>Status</strong>: Shows "Processing audio..." during processing and "Audio processed successfully" when complete. The audio player and waveform display appear automatically.</li>
    <li><strong>Note</strong>: Ensure all required tracks are uploaded, or the status display will show an error.</li>
</ul>
<h3>4. Playing and Controlling Audio</h3>
<ul>
    <li><strong>Access</strong>: Click the <strong>Show/Hide Player</strong> node (cyan, labeled "Show/Hide Player") to toggle the audio player.</li>
    <li><strong>Controls</strong>:
        <ul>
            <li><strong>Play/Pause</strong>: Use the audio player's built-in controls.</li>
            <li><strong>Stop</strong>: Click the <strong>Stop Audio</strong> node (magenta, labeled "Stop Audio") or the stop button (■) on the player to stop and reset playback.</li>
            <li><strong>Close Player</strong>: Click the close button (×) on the player to hide it.</li>
 <li><strong>IMPORTANT</strong>: The app accepts files of any Sampling Rate with a file limit of 50Mb. </li>
     <li><strong>IMPORTANT</strong>: Wait until 'Audio Rendering Complete' to hear the final output. Large files takes time to process. </li>
 <li><strong>IMPORTANT</strong>: Start with small loop times, e.g 1 minute (default 5 minutes) and also start with small file size (less than 10Mb.</li>
<li><strong>IMPORTANT</strong>: Depending of the audio content and Pitch Detection algorithm used (Filter, Transpose, Reorder), Process Audio may not be able to continue.</li>
 <li><strong>More:</strong>: When you get the app's logic, move to larger times and sizes (expect long rendering times)</li>
        </ul>
    </li>
    <li><strong>Visualization</strong>: The waveform display (toggled separately) scrolls in real-time, and the logo and nodes glow in sync with the audio's intensity.</li>
</ul>
<h3>5. Toggling Waveform Display</h3>
<ul>
    <li><strong>Access</strong>: Click the <strong>Show/Hide Waveform</strong> node (purple, labeled "Show/Hide Waveform") to toggle the waveform display.</li>
    <li><strong>Action</strong>: Shows or hides the real-time scrolling waveform of the mixed audio. The waveform automatically hides after the audio completes one full loop.</li>
    <li><strong>Visualization</strong>: The waveform node pulses slowly with a glowing effect, enhancing the cyberpunk aesthetic.</li>
</ul>
<h3>6. Downloading the Mix</h3>
<ul>
    <li><strong>Access</strong>: In the control panel (after clicking "Process Audio"), click the <strong>Download Mix</strong> button.</li>
    <li><strong>Action</strong>: Downloads the processed mix as a WAV file named "mixed-audio.wav".</li>
    <li><strong>Status</strong>: Shows "Downloading mix..." during the process.</li>
</ul>
<h3>Scale Behavior with Imported Audio</h3>
<p>The Scale Behavior options transform your audio files in different musical ways:</p>

<ul>
    <li><strong>Filter</strong>:
        <ul>
            <li>Only keeps audio files that match the selected scale</li>
            <li>Files not in the scale are removed from the mix</li>
            <li>Best for curated collections where you want strict harmonic consistency</li>
            <li>Example: In C Major scale, only files detected as C, D, E, F, G, A, or B will be used</li>
        </ul>
    </li>
    
    <li><strong>Transpose</strong>:
        <ul>
            <li>Automatically shifts pitches of all files to match the selected scale</li>
            <li>Preserves the original character while ensuring harmonic compatibility</li>
            <li>May cause slight artifacts with complex/polyphonic audio</li>
            <li>Example: A D# file would be transposed to D in C Major scale</li>
        </ul>
    </li>
    
    <li><strong>Reorder</strong>:
        <ul>
            <li>Keeps all files but rearranges them in scale order</li>
            <li>Files in-scale appear first, followed by out-of-scale files</li>
            <li>Creates a musically ascending/descending progression</li>
            <li>Example: Files would play as C, D, E, F, then any remaining files</li>
        </ul>
    </li>
</ul>

<p><strong>Detection Method</strong>: The system analyzes each file's:
    <ul>
        <li>Spectral centroid (dominant frequency)</li>
        <li>Filename for key hints (e.g., "C_Melody.wav")</li>
        <li>Harmonic content via FFT analysis</li>
    </ul>
</p>

<h3>Algorithm Behavior with Imported Audio</h3>
<p>The Algorithm determines how your files are sequenced in the mix:</p>

<ul>
    <li><strong>Sequential</strong>:
        <ul>
            <li>Plays files in upload order (Track 1 → Track 2 → etc.)</li>
            <li>Creates predictable, structured mixes</li>
        </ul>
    </li>
    
    <li><strong>Random</strong>:
        <ul>
            <li>Shuffles files with no repeating pattern</li>
            <li>Produces unexpected combinations each time</li>
        </ul>
    </li>
    
    <li><strong>Markov Chain</strong>:
        <ul>
            <li>Creates semi-random sequences based on transition probabilities</li>
            <li>Learns patterns from your file characteristics</li>
            <li>Balances randomness with musical flow</li>
        </ul>
    </li>
    
    <li><strong>Scale-based Order</strong>:
        <ul>
            <li>Ascending: Low notes → high notes in the scale</li>
            <li>Descending: High notes → low notes in the scale</li>
            <li>Creates melodic progressions</li>
        </ul>
    </li>
    
    <li><strong>Frequency-based Order</strong>:
        <ul>
            <li>Ascending: Darker sounds → brighter sounds</li>
            <li>Descending: Bright sounds → dark sounds</li>
            <li>Creates timbral evolution</li>
        </ul>
    </li>
    
    <li><strong>Tempo-based Order</strong>:
        <ul>
            <li>Ascending: Slower BPM → faster BPM</li>
            <li>Descending: Faster BPM → slower BPM</li>
            <li>Creates rhythmic development</li>
        </ul>
    </li>
</ul>

<p><strong>Pro Tip</strong>: Combine Scale Behavior with Algorithms for powerful results:
    <ul>
        <li>Filter + Markov Chain = Cohesive yet surprising harmonic mixes</li>
        <li>Transpose + Scale Order = Perfect ascending/descending melodies</li>
        <li>Reorder + Frequency Order = Evolving timbral landscapes</li>
    </ul>
</p>
<h3>8. Visual Feedback</h3>
<ul>
    <li><strong>Mandala</strong>: Nodes glow and pulse when clicked or during audio playback, with colors matching their function (e.g., cyan for player, purple for waveform).</li>
    <li><strong>Fractal Canvas</strong>: A dynamic background that scales and rotates, reacting to time and audio.</li>
    <li><strong>Logo</strong>: The "o r a c L e" text glows with a cybernetic pulse, intensifying with audio output.</li>
    <li><strong>Waveforms</strong>: Each uploaded track shows a waveform in the file upload panel, and the mixed audio has a scrolling waveform in the waveform display.</li>
</ul>
<h3>9. Accessing Help</h3>
<ul>
    <li><strong>Access</strong>: Click the <strong>Help</strong> node (teal, labeled "Help") in the mandala.</li>
    <li><strong>Action</strong>: Opens a popup panel displaying this manual. Click the close button (×) to dismiss it.</li>
    <li><strong>Status</strong>: No status message is shown for opening/closing the help panel.</li>
</ul>
<h2>Tips for Use</h2>
<ul>
    <li><strong>File Formats</strong>: Use common audio formats (MP3, WAV). Ensure files are not corrupted.</li>
    <li><strong>Track Count</strong>: Set the number of tracks before uploading to avoid resetting uploads.</li>
    <li><strong>Processing Time</strong>: Large files or long loop durations may take longer to process.</li>
    <li><strong>Browser Compatibility</strong>: Use a modern browser (Chrome, Firefox) with Web Audio API support.</li>
    <li><strong>Responsive Design</strong>: The interface adapts to window size, but nodes may reposition on resize.</li>
</ul>
<h2>Precautions</h2>
<ul>
    <li><strong>File Size - Type Limits</strong>: Maximum File Size: 50MB per file (hardcoded limit). Supported Formats: WAV (Any Sampling Rate and Bit Depth, however stay at 44.1, 16Bit for quicker rendering), MP3, OGG. </li>
  <li><strong>Browser-Specific Issues</strong>: Safari: May have issues with Web Audio API timing, however webkitAudioContext fallback is included. Mobile Browsers: Auto-play restrictions (audio must start via user gesture) and  Limited memory for large files.</li>
    <li><strong>Avoid</strong>: Silent Files (will fail validation). Corrupted Headers (WAV/MP3 with bad metadata). Very Short Files (<0.5s may break BPM detection). Keep in mind that Polyphonic Music pitch detection works best on monophonic sounds.</li>
    <li><strong>Memory Intensive Operations</strong>: Avoid processing multiple long files simultaneously. Extreme reverb times (>5s). High track counts (8+) with long loops (>5min).</li>
</ul>
<h2>Troubleshooting</h2>
<ul>
    <li><strong>No Status Messages</strong>: Ensure JavaScript is enabled. Check the console (F12) for errors.</li>
  <li><strong>Invalid Audio Buffer</strong>: A common issue where one of the uploaded files is larger in time than the selected Loop Time. Upload another file or adjust Loop Time.</li>
    <li><strong>Audio Not Playing</strong>: Verify files are valid and audio output is not muted.</li>
    <li><strong>Processing Fails</strong>: Check if all tracks are uploaded and parameters are valid.</li>
    <li><strong>Nodes Not Responding</strong>: Refresh the page and ensure the browser window is focused.</li>
</ul>
<h2>Links to Audio Files For Testing</h2>
<ul>

<h2>Comments, Bugs, Suggestions</h2>
<ul>
    <li><strong>Contact</strong>: tokenomusic@gmail.com </li>
    <li><a href="http://tokeno.net"  style="color:yellow;"> Visit tokeno.net</a></li>

</ul>
<h2>Links to Audio Files For Testing</h2>
<ul>
  
    <li><a href="https://github.com/tokenno/oracle/tree/main/mp3" style="color:yellow;"> Test Audio Files for five tracks.</a></li>
 
</ul>
<p><em>tokeno.net [ o r a c L e ]</em></p>
        `;

        helpContent.innerHTML = manualContent;

        closeHelp.addEventListener('click', () => {
            helpPanel.style.display = 'none';
            if (window.p5) loop();
        });

        // Error Handling... 
        try {
            console.log('Script execution started');

            // Mandala background
            function setup() {
                console.log('p5 setup started');
                let canvas = createCanvas(windowWidth, windowHeight);
                if (!canvas) throw new Error('Canvas creation failed');
                canvas.parent('fractal-canvas');
                colorMode(HSB, 360, 100, 100, 1);
                noFill();
                angleMode(DEGREES);
                loop();
                console.log('p5 setup complete');
            }

            let time = 0;
            function draw() {
                background(0, 0, 0, 0.1);
                translate(width / 2, height / 2);
                let scale = map(sin(time * 0.05), -1, 1, 0.8, 1.2);
                drawMandala(0, 0, 200 * scale, 8, 4);
                time += 0.1;
            }

            function drawMandala(x, y, radius, sides, depth) {
                if (depth <= 0 || radius < 10) return;
                let hue = (time * 5 + depth * 60) % 360;
                stroke(hue, 80, 100, 0.5);
                strokeWeight(depth * 0.5);
                beginShape();
                for (let i = 0; i < 360; i += 360 / sides) {
                    let angle = i + sin(time + depth * 10) * 10;
                    let r = radius * (0.8 + sin(time + i) * 0.2);
                    let px = x + cos(angle) * r;
                    let py = y + sin(angle) * r;
                    vertex(px, py);
                }
                endShape(CLOSE);
                let newRadius = radius * 0.6;
                drawMandala(x, y, newRadius, sides, depth - 1);
            }

            function windowResized() {
                resizeCanvas(windowWidth, windowHeight);
            }
            
            let isBlinkingActive = false;
let blinkIntervals = [];
            
function calculateBlinkSpeed() {
    const bpm = parseInt(document.getElementById('project-bpm-slider')?.value) || 120;
    const playbackRate = parseFloat(document.getElementById('playback-rate')?.value) || 1.0;
    
    // Base blink duration (ms) 
    const baseDuration = 500; 
    
    // Adjust based on BPM 
    let duration = baseDuration * (120 / bpm);
    
    // Adjust based on playback rate (faster playback = faster blinks)
    duration /= playbackRate;
    
    // Clamp between 100ms and 1000ms
    return Math.max(100, Math.min(1000, duration));
}

function startTempoSyncedBlinking() {
    const nodes = document.querySelectorAll('.parameter-node:not(#node-waveform)');
    if (!nodes.length) return;
    
    stopNodeBlinking();
    isBlinkingActive = true;
    
    const blinkNode = () => {
        if (!isBlinkingActive) return;
        
        // Calculate dynamic blink speed
        const blinkDuration = calculateBlinkSpeed();
        
        // Clear all blinking first
        nodes.forEach(node => node.classList.remove('blinking'));
        
        // Select a random node (70% chance)
        if (Math.random() > 0.3) {
            const randomIndex = Math.floor(Math.random() * nodes.length);
            const node = nodes[randomIndex];
            const nodeColor = getComputedStyle(node).getPropertyValue('color').trim() || 'rgba(255, 255, 255, 0.8)';
            
            // Set dynamic properties
            node.style.setProperty('--glow-color', nodeColor);
            node.style.setProperty('--blink-duration', `${blinkDuration}ms`);
            node.classList.add('blinking');
            
            // Remove blink after duration
            setTimeout(() => {
                node.classList.remove('blinking');
            }, blinkDuration);
        }
        
        // Schedule next blink with tempo-synced timing
        const nextBlinkDelay = blinkDuration * (0.5 + Math.random() * 0.5); // 50-100% of blink duration
        const interval = setTimeout(blinkNode, nextBlinkDelay);
        blinkIntervals.push(interval);
    };
    
    blinkNode();
}

// Update Stoop Function
function stopNodeBlinking() {
    console.log('Stopping all node blinking');
    isBlinkingActive = false;
    blinkIntervals.forEach(interval => clearTimeout(interval));
    blinkIntervals = [];
    document.querySelectorAll('.parameter-node').forEach(node => {
        node.classList.remove('blinking');
    });
}

            // Position nodes dynamically
            const nodes = document.querySelectorAll('.parameter-node');
            console.log('Nodes found:', nodes.length);
            const mandala = document.getElementById('audio-mandala');
            if (!mandala) console.error('Mandala element not found');
            function positionNodes() {
                if (!mandala) {
                    console.error('Mandala element not found during positioning');
                    return;
                }
                const radiusOuter = 45;
                const radiusInner = 25;
                const count = nodes.length;
                const outerCount = Math.ceil(count / 2);
                nodes.forEach((node, i) => {
                    const isOuter = i < outerCount;
                    const r = isOuter ? radiusOuter : radiusInner;
                    const angle = (i % outerCount) * (360 / outerCount);
                    const x = 50 + r * Math.cos(angle * Math.PI / 180);
                    const y = 50 + r * Math.sin(angle * Math.PI / 180);
                    node.style.left = `${x}%`;
                    node.style.top = `${y}%`;
                    const tooltip = node.querySelector('.node-tooltip');
                    if (tooltip) tooltip.textContent = node.dataset.tooltip || '';
                });
                console.log('Nodes positioned');
            }
            positionNodes();
            window.addEventListener('resize', positionNodes);


      // Node interactions
const controlPanel = document.getElementById('control-panel');
const fileInputs = document.getElementById('file-inputs');
const audioPlayer = document.getElementById('audio-player-container');
const waveformContainer = document.getElementById('waveform-container');
const closePlayer = document.getElementById('close-player');
const stopAudioBtn = document.getElementById('stop-audio-btn');
const helpPanel = document.getElementById('help-panel');
const connections = document.querySelectorAll('.node-connection');


if (nodes && controlPanel && fileInputs && audioPlayer && closePlayer && waveformContainer && stopAudioBtn && helpPanel) {
    console.log('Node interactions initialized');
    
    // Track currently active node
    let activeNode = null;
    
    nodes.forEach(node => {
        const tooltip = node.querySelector('.node-tooltip');
        
        // Show tooltip on hover (only if node hasn't been clicked)
        node.addEventListener('mouseenter', () => {
            if (node !== activeNode) {
                tooltip.style.opacity = '1';
            }
        });
        
        // Hide tooltip when mouse leaves
        node.addEventListener('mouseleave', () => {
            tooltip.style.opacity = '0';
        });
        
        node.addEventListener('click', (e) => {
            console.log('Node clicked:', node.id);
            
            // Check if this node is already active
            const wasActive = node === activeNode;
            
            // Hide all tooltips
            document.querySelectorAll('.node-tooltip').forEach(t => {
                t.style.opacity = '0';
            });

  // Hide Process Panel
    document.getElementById('process-btn')?.addEventListener('click', function() {
        controlPanel.style.display = 'none';
        document.getElementById('node-process')?.classList.remove('active');
    });
            
            // Remove active class from all nodes
            nodes.forEach(n => n.classList.remove('active'));
            
            // Hide all panels
            document.querySelectorAll('.control-group').forEach(c => c.style.display = 'none');
            fileInputs.style.display = 'none';
            helpPanel.style.display = 'none';
            controlPanel.style.display = 'none';
            audioPlayer.style.display = 'none';
            waveformContainer.style.display = 'none';
            
            // Toggle behavior - if node was already active, deactivate it
            if (!wasActive) {
                activeNode = node;
                node.classList.add('active');
                
                const controlId = `control-${node.id.replace('node-', '')}`;
                const control = document.getElementById(controlId);
                
                if (node.id === 'node-file-inputs') {
                    fileInputs.style.display = 'block';
                } 
                else if (node.id === 'node-player') {
                    audioPlayer.style.display = 'block';
                } 
                else if (node.id === 'node-waveform') {
                    waveformContainer.style.display = 'block';
                } 
                else if (node.id === 'node-help') {
                    helpPanel.style.display = 'block';
                }
                else if (control) {
                    control.style.display = 'block';
                    controlPanel.style.display = 'block';
                }
            } else {
                activeNode = null;
            }
            
            if (node.id === 'node-stop-audio') {
                console.log('Stop Audio node clicked');
                const audio = document.getElementById('mixed-audio');
                if (audio) {
                    console.log('Attempting to stop audio');
                    audio.pause();
                    audio.currentTime = 0;
                    if (window.stopPlayback) {
                        window.stopPlayback();
                        console.log('stopPlayback called');
                    }
                } else {
                    console.error('Mixed audio element not found');
                }
            }

            const ripple = document.createElement('div');
            ripple.className = 'ripple-effect';
            ripple.style.left = `${e.clientX}px`;
            ripple.style.top = `${e.clientY}px`;
            ripple.style.width = '30px';
            ripple.style.height = '30px';
            document.body.appendChild(ripple);
            setTimeout(() => ripple.remove(), 1000);

            if (window.p5) time += p5.prototype.random(1, 3);
        });
    });

    // Reset active node when clicking outside
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.parameter-node')) {
            nodes.forEach(node => {
                node.classList.remove('active');
            });
            activeNode = null;
        }
    });

   
    closePlayer.addEventListener('click', () => {
        audioPlayer.style.display = 'none';
        if (window.p5) loop();
    });

    stopAudioBtn.addEventListener('click', () => {
        console.log('Stop button clicked');
        const audio = document.getElementById('mixed-audio');
        if (audio) {
            console.log('Attempting to stop audio via button');
            audio.pause();
            audio.currentTime = 0;
            if (window.stopPlayback) {
                window.stopPlayback();
                console.log('stopPlayback called from button');
            }
        }
    });

                let trackCount = parseInt(document.getElementById('track-count')?.value) || 5;
                const trackCountInput = document.getElementById('track-count');
                if (trackCountInput) {
                    trackCountInput.addEventListener('change', () => {
                        trackCount = parseInt(trackCountInput.value) || 5;
                        window.showStatus(`Track count set to ${trackCount}. Upload files.`, 'click');
                    });
                }

             const loopDurationInput = document.getElementById('loop-duration');
const loopDurationValue = document.getElementById('loop-duration-value');
if (loopDurationInput && loopDurationValue) {
    // Set default value to 1.0 (1 minute)
    loopDurationInput.value = '1.0';
    loopDurationValue.textContent = '1.0';
    
    loopDurationInput.addEventListener('input', () => {
        const value = parseFloat(loopDurationInput.value).toFixed(1);
        loopDurationValue.textContent = `${value}`;
        window.showStatus(`Loop duration set to ${value} min.`, 'info');
    });
    
    // Initialize with the correct display value
    loopDurationValue.textContent = `${parseFloat(loopDurationInput.value).toFixed(1)}`;
}

                const fileInputsObserver = new MutationObserver(() => {
                    try {
                        console.log('MutationObserver triggered');
                        const fileUploadInputs = fileInputs.querySelectorAll('input[type="file"]');
                        console.log(`Found ${fileUploadInputs.length} file inputs`);
                        if (!fileUploadInputs.length) {
                            console.warn('No file inputs found in #file-inputs');
                            window.showStatus('No file inputs detected. Please upload files.', 'warning');
                            return;
                        }
                        const selectedFiles = Array.from(fileUploadInputs).filter(inp => inp.files.length > 0);
                        console.log(`Selected files: ${selectedFiles.length}/${trackCount}`);
                        if (selectedFiles.length > 0) {
                            window.showStatus(`${selectedFiles.length}/${trackCount} tracks loaded.`, 'info');
                        }
              if (selectedFiles.length >= trackCount) {
    fileInputs.style.display = 'none';
    document.getElementById('node-file-inputs')?.classList.remove('active'); // <-- Added this
    document.querySelectorAll('.node-tooltip').forEach(tooltip => tooltip.style.opacity = '0');
    window.showStatus('All tracks loaded. Ready to process.', 'success');
                            if (window.p5) loop();
                            positionNodes();
                            updateConnections();
                            const canvas = document.getElementById('fractal-canvas');
                            if (canvas) canvas.style.display = 'block';
                            const event = new Event('allTracksLoaded');
                            fileInputs.dispatchEvent(event);
                        }
                    } catch (e) {
                        console.error('File input observer error:', e);
                        window.showStatus('Error monitoring file inputs. Check console.', 'error');
                    }
                });
                fileInputsObserver.observe(fileInputs, { childList: true, subtree: true });

                function updateConnections() {
                    if (!mandala) {
                        console.error('Mandala element not found for connections');
                        return;
                    }
                    const mandalaRect = mandala.getBoundingClientRect();
                    const centerX = mandalaRect.left + mandalaRect.width / 2;
                    const centerY = mandalaRect.top + mandalaRect.height / 2;
                    connections.forEach((conn, i) => {
                        const node1 = nodes[i % nodes.length];
                        const node2 = nodes[(i + 1) % nodes.length];
                        if (!node1 || !node2) return;
                        const rect1 = node1.getBoundingClientRect();
                        const rect2 = node2.getBoundingClientRect();
                        const x1 = rect1.left + rect1.width / 2 - mandalaRect.left;
                        const y1 = rect1.top + rect1.height / 2 - mandalaRect.top;
                        const x2 = rect2.left + rect2.width / 2 - mandalaRect.left;
                        const y2 = rect2.top + rect2.height / 2 - mandalaRect.top;
                        const length = Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2);
                        const angle = Math.atan2(y2 - y1, x2 - x1) * 180 / Math.PI;
                        conn.style.width = `${length}px`;
                        conn.style.left = `${x1}px`;
                        conn.style.top = `${y1}px`;
                        conn.style.transform = `rotate(${angle}deg)`;
                    });
                }

                window.addEventListener('resize', () => {
                    positionNodes();
                    updateConnections();
                    if (window.p5) loop();
                });
                updateConnections();

                window.showStatus = window.showStatus || function(message, type) {
                    const statusDisplay = document.getElementById('status-display');
                    if (statusDisplay) {
                        statusDisplay.innerHTML = `<div class="status-message ${type}">${message}</div>`;
                        statusDisplay.style.display = 'block';
                        setTimeout(() => statusDisplay.style.display = 'none', 3000);
                    } else {
                        console.log(`Status: ${message} (${type})`);
                    }
                };
            } else {
                console.error('Required elements not found:', { nodes, controlPanel, fileInputs, audioPlayer, closePlayer, waveformContainer, stopAudioBtn, helpPanel });
            }

            // Logo glow (not currently implemented) and waveform animation tied to audio output
            const audio = document.getElementById('mixed-audio');
            const logo = document.getElementById('logo');
            let audioContext, analyser, source;
            let isAudioAnalysisSetup = false;

            function setupAudioAnalysis() {
                if (!audio || !logo || isAudioAnalysisSetup) return;
                try {
                    isAudioAnalysisSetup = true;
                    console.log('Setting up audio analysis');
                    if (!audioContext) {
                        audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        analyser = audioContext.createAnalyser();
                        analyser.fftSize = 256;
                        source = audioContext.createMediaElementSource(audio);
                        source.connect(analyser);
                        analyser.connect(audioContext.destination);
                    }

                    const bufferLength = analyser.fftSize;
                    const dataArray = new Uint8Array(bufferLength);

                    function updateGlow() {
                        try {
                            analyser.getByteTimeDomainData(dataArray);
                            let sum = 0;
                            for (let i = 0; i < bufferLength; i++) {
                                const sample = (dataArray[i] - 128) / 128;
                                sum += sample * sample;
                            }
                            const rms = Math.sqrt(sum / bufferLength);
                            const glowIntensity = Math.min(rms * 50, 20);
                            logo.style.textShadow = `0 0 ${5 + glowIntensity}px rgba(123, 211, 247, ${0.5 + rms * 0.5})`;
                            if (!audio.paused) requestAnimationFrame(updateGlow);
                        } catch (e) {
                            console.error('Glow update error:', e);
                            window.showStatus('Glow effect update failed.', 'error');
                        }
                    }

                    updateGlow();
                } catch (e) {
                    console.error('Audio analysis setup failed:', e);
                    window.showStatus('Audio glow effect failed. Check console.', 'error');
                    isAudioAnalysisSetup = false;
                }
            }

            // Scrolling waveform
            let waveformSketch = function(p) {
                let dataArray;
                let bufferLength;

                p.setup = function() {
                    console.log('Waveform sketch setup started');
                    let canvas = p.createCanvas(150, 150);
                    canvas.id('waveform-canvas'); 
                    canvas.parent('waveform-container');
                    p.background(0);
                    if (analyser) {
                        bufferLength = analyser.fftSize;
                        dataArray = new Uint8Array(bufferLength);
                    } else {
                        console.error('Analyser not found in waveform setup');
                    }
                    console.log('Waveform sketch setup complete');
                };

                p.draw = function() {
                    if (!audio || audio.paused || !analyser) {
                        p.background(0);
                        return;
                    }
                    console.log('Drawing waveform');
                    p.push();
                    let img = p.get(1, 0, p.width - 1, p.height);
                    p.background(0);
                    p.image(img, 0, 0);
                    analyser.getByteTimeDomainData(dataArray);
                    p.stroke(123, 211, 247);
                    p.strokeWeight(1);
                    p.noFill();
                    let x = p.width - 1;
                    let y = p.map(dataArray[0], 0, 255, p.height, 0);
                    p.line(x, p.height / 2, x, y);
                    p.pop();
                };
            };

            // Add random glowing effect for parameter nodes when audio plays
            let animationFrameId = null;

            function updateNodeGlow() {
                console.log('Updating node glow');
                nodes.forEach(node => {
                    const randomIntensity = Math.random() * 15 + 5;
                    const randomOpacity = Math.random() * 0.5 + 0.3;
                    const randomHue = Math.floor(Math.random() * 360);
                    node.style.boxShadow = `0 0 ${randomIntensity}px rgba(${randomHue}, 80%, 80%, ${randomOpacity})`;
                });
                if (!audio.paused && animationFrameId === null) {
                    animationFrameId = requestAnimationFrame(updateNodeGlow);
                }
            }

            audio.addEventListener('play', () => {
                console.log('Audio play event triggered');
                setupAudioAnalysis();
                if (window.p5 && !window.waveformInstance) {
                    window.waveformInstance = new p5(waveformSketch);
                }
                updateNodeGlow();
            });

            audio.addEventListener('pause', () => {
                console.log('Audio pause event triggered');
                if (window.waveformInstance) {
                    window.waveformInstance.background(0);
                }
                if (animationFrameId !== null) {
                    cancelAnimationFrame(animationFrameId);
                    animationFrameId = null;
                }
                nodes.forEach(node => {
                    node.style.boxShadow = '0 0 10px rgba(255, 255, 255, 0.3)';
                });
            });

            audio.addEventListener('ended', () => {
                console.log('Audio ended event triggered');
               
                waveformContainer.style.display = 'none';
                if (window.waveformInstance) {
                    window.waveformInstance.background(0);
                }
                if (animationFrameId !== null) {
                    cancelAnimationFrame(animationFrameId);
                    animationFrameId = null;
                }
                nodes.forEach(node => {
                    node.style.boxShadow = '0 0 10px rgba(255, 255, 255, 0.3)';
                });
            });
        } catch (e) {
            console.error('UI initialization failed:', e);
            const statusDisplay = document.getElementById('status-display');
            if (statusDisplay) {
                statusDisplay.innerHTML = '<div class="status-message error">UI failed to load. Check console for details.</div>';
                statusDisplay.style.display = 'block';
            }
        }
    </script>
</body>
</html>
